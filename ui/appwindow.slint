import { Button, VerticalBox,HorizontalBox, StandardTableView, TabWidget, TextEdit, CheckBox, ProgressIndicator } from "std-widgets.slint";
import { FileTable, Download } from "widgets/filetable.slint";
import { Palette as CosmicPalette } from "styling.slint";
import { ErrorDialog } from "widgets/errordialog.slint";
import { ModTable } from "widgets/mod-table.slint";
import { DivaModElement, ModPackElement } from "diva-types.slint";
import { ModPickTable, PackTable } from "widgets/modpack-tables.slint";
import { ContextMenu } from "widgets/context-menu.slint";
import { TextEntryDialog } from "widgets/text-entry-dialog.slint";
import { ModpackLogic, ModLogic } from "applogic.slint";
import { InfoDialog } from "widgets/info-dialog.slint";
import { TextBox } from "widgets/text-box.slint";
import { DeletePackDialog } from "widgets/delete-pack-dialog.slint";

export { ModPackElement, ModpackLogic, ModLogic }

export struct SlintModConfig {
    enabled: bool,
    include: [string],
    name: string,
    descrition: string,
    version: string,
    author: string,
    date: string,
    dll: [string]
}



export component App inherits Window {
    min-width: 1280px;
    preferred-width: 1280px;
    min-height: 900px;
    preferred-height: 900px;
    title: "Rust4Diva: Project Diva MM+ Mod Manager";
    in property <int> counter: 4;
    in property <[int]> fs: [1, 2, 3];

    in property <[[StandardListViewItem]]> search-results: [];

    in property <[Download]> file-results: [];
    in property <[{key: int, value: Download}]> downloads-map;
    in-out property <[Download]> downloads-list: [];
    in property <[[StandardListViewItem]]> stuff: [];

    in property <string> dml-version: "";
    in-out property <bool> dml-enabled: false;
    in-out property <string> selected-search: "";
    in-out property <string> selected-file: "";

    in-out property <int> temp-pos;
    in property <bool> s-prog-vis: false;

    in-out property <bool> show-error: true;
    in-out property <bool> pack-modified: false;
    in-out property <string> error-msg: "This is a test message";

    property window_width <=> self.width;
    property window_height <=> self.height;

    in property <[DivaModElement]> mods: [];
    in-out property <[DivaModElement]> pack-mods: [];
    in-out property <[string]> modpacks: [];

    callback load-mods <=> load-mods-btn.clicked;
    callback toggle-mod(int);
    callback toggle-dml();
    callback search-gb(string);
    callback list-files(int);
    callback download-file(Download, int);
    callback open-file-picker;
    callback add-mod-to-pack(DivaModElement, string);
    callback remove-mod-from-pack(DivaModElement, string);
    callback modpack-changed(string);
    callback save-modpack(string, [DivaModElement]);
    callback apply-modpack([DivaModElement]);

    public function open-error-dialog(error-msg: string) {
        root.error-msg = error-msg;
        errordialog.show();
    }

    default-font-size: 16px;
    errordialog := ErrorDialog {
        x: (window_width / 2) - 100px;
        y: (window_height / 2) - 100px;

        msg: error-msg;
    }

    packcreator := TextEntryDialog {
        // x: (window_width / 2) - 100px;
        // y: (window_height / 2) - 100px;
        offset_x: -100px;
        accepted(text) => {
            ModpackLogic.create-new-pack(text);
        }
    }

    aboutdialog := InfoDialog { }

    confirmdeletepack := DeletePackDialog {}

    VerticalLayout {
        HorizontalBox {
            Button {
                horizontal-stretch: 1;
                text: "Install Mod Archive";
                clicked => {
                    open-file-picker();
                }
            }

            Button {
                horizontal-stretch: 1;
                text: "About Rust4Diva";
                clicked => {
                    aboutdialog.show();
                }
            }

            Button {
                horizontal-stretch: 1;
                text: "Open Settings";
                clicked => {
                    // errordialog.show();
                }
            }
        }

        HorizontalBox {
            Text {
                text: "Diva Mod Loader";
            }

            Text {
                text: "Version: " + dml-version;
            }

            CheckBox {
                checked: dml-enabled;
                text: dml-enabled ? "Enabled" : "Disabled";
                toggled => {
                    dml-enabled = !dml-enabled;
                    toggle-dml();
                }
            }
        }

        TabWidget {
            manager := Tab {
                title: "Mods";
                VerticalBox {

                    test-table := ModTable {
                        min-width: window_width - 12px;
                        height: window_height - 210px;
                        columns: [
                            { title: "Enabled", width: 100px },
                            { title: "Priority", width: 100px },
                            { title: "Name" },
                            { title: "Authors" },
                            { title: "Version", width: 100px },
                            { title: "Description" }
                        ];
                        mods: mods;
                        mod-toggled(index, module) => {
                            ModLogic.toggle-mod(module);
                        }
                    }

                    mgmt:=HorizontalBox {
                        load-mods-btn := Button {
                            horizontal-stretch: 1;
                            width: (window_width - (mgmt.spacing * 5)) / 2;
                            text: "Reload Mods";
                            icon: @image-url("assets/repeat-solid.svg");
                        }
                        Button {
                            horizontal-stretch: 1;
                            width: (window_width - (mgmt.spacing * 5)) / 2;
                            text: "Apply Priority (Disables currently active modpack)";
                            icon: @image-url("assets/repeat-solid.svg");
                            clicked => {
                                apply-modpack([]);
                            }
                        }
                    }
                }
            }

            packs-tab := Tab {
                title: "Modpacks";

                VerticalBox {
                    HorizontalLayout {
                        packsctx-menu := ContextMenu {
                            min_menu_width: window_width - 440px;
                            offset_x: -((self.x + self.min_menu_width) - (packbtn.x + packbtn.width));
                            offset_y: packbtn.height;
                            width: 300px;
                            model: modpacks;
                            horizontal_alignment: center;
                            item-clicked(idx) => {
                                modpack-changed(modpacks[idx]);
                                pack-modified = false;
                            }
                        }
                    }

                    HorizontalLayout {
                        packbtn := Button {
                            width: window_width - 400px;
                            text: packsctx-menu.current_item != -1 ? "Editing: " + packsctx-menu.model[packsctx-menu.current_item] : "";
                            clicked => {
                                if (packsctx-menu.model.length == 0) {
                                    return;
                                }
                                packsctx-menu.show_and_focus();
                            }
                        }

                        Button {
                            text: "Add New Pack";
                            clicked => {
                                packcreator.show();
                            }
                            width: 180px;
                        }
                        Button {
                            text: "Delete Modpack";
                            width: 180px;
                            enabled: packsctx-menu.current_item != -1;
                            clicked => {
                                confirmdeletepack.show-with(packsctx-menu.model[packsctx-menu.current_item]);
                            }
                        }
                    }

                    HorizontalBox {
                        VerticalBox {
                            Text {
                                text: "Installed";
                            }

                            mod-picker := ModPickTable {
                                width: (window_width / 2) - 100px;
                                // height: 100%;
                                height: window_height - 360px;
                                columns: [{ title :"Name" }];
                                mods: mods;
                            }

                            Button {
                                text: "Reload";
                                clicked => {
                                    load-mods();
                                }
                            }
                        }

                        VerticalBox {
                            Button {
                                icon: @image-url("assets/right-long-solid.svg");
                                clicked => {
                                    if packsctx-menu.current_item != -1 {
                                        if mod-picker.current-row != -1 {
                                            add-mod-to-pack(mods[mod-picker.current-row], modpacks[packsctx-menu.current_item]);
                                            packsctx-menu.set-current-item(-1);
                                            pack-modified = true;
                                        }
                                    }
                                }
                            }

                            Button {
                                enabled: pack-mods.length > 0;
                                icon: @image-url("assets/left-long-solid.svg");
                                clicked => {
                                    if packsctx-menu.current_item != -1 {
                                        if in-pack.current-row != -1 {
                                            remove-mod-from-pack(pack-mods[in-pack.current-row], modpacks[packsctx-menu.current_item]);
                                            packsctx-menu.set-current-item(-1);
                                            pack-modified = true;
                                        }
                                    }
                                }
                            }
                        }

                        VerticalBox {
                            Text {
                                text: "In Modpack";
                            }

                            in-pack := ModPickTable {
                                width: (window_width / 2) - 100px;
                                height: window_height - 360px;
                                columns: [{ title :"Name" }];
                                mods: pack-mods;
                            }

                            Button {
                                text: "Save";
                                clicked => {
                                    if packsctx-menu.current_item > -1 {
                                        save-modpack(modpacks[packsctx-menu.current_item], pack-mods);
                                        pack-modified = false;
                                    }
                                }
                            }
                        }
                    }

                    aply-btns := HorizontalBox {
                        Button {
                            width: (window_width - (aply-btns.spacing * 5)) / 2;
                            enabled: packsctx-menu.current_item != -1 && !pack-modified;
                            text: "Apply Modpack";
                            clicked => {
                                apply-modpack(pack-mods);
                            }
                        }

                        Button {
                            width: (window_width - (aply-btns.spacing * 5)) / 2;
                            text: "Repeal Modpacks";
                            clicked => {
                                apply-modpack([]);
                            }
                        }
                    }
                }
            }

            search-tab := Tab {
                title: "Search Online";
                VerticalBox {
                    HorizontalBox {
                        search := Text {
                            height: 36px;
                            y: 3px;
                            font-size: 22px;
                            text: "Search: ";
                            vertical-alignment: TextVerticalAlignment.center;
                        }

                        TextBox {
                            accepted(text) => {
                                search-gb(text);
                            }
                        }

                        search-prog := ProgressIndicator {
                            visible: s-prog-vis;
                            height: 32px;
                            width: 100px;
                            indeterminate: true;
                            progress: 0;
                        }
                    }

                    search-table := StandardTableView {
                        columns: [{ title: "Name" }, { title: "Authors" }, { title: "Category" }];
                        rows: search-results;
                        current-row-changed(row) => {
                            selected-search = search-results[row][0].text;
                        }
                    }

                    HorizontalBox {
                        Text {
                            text: "Selected Mod: " + selected-search;
                        }

                        Button {
                            text: "List files";
                            width: (window_width / 2) - 40px;
                            clicked => {
                                list-files(search-table.current-row);
                            }
                        }
                    }

                    files-table := FileTable {
                        columns: [{ title: "Name" }, { title: "Size" }];
                        files: file-results;
                        current-row-changed(row) => {
                            // selected-file = row;
                            selected-file = file-results[row].name;
                        }
                    }

                    HorizontalBox {
                        Text {
                            text: "Selected File: " + selected-file;
                        }

                        Button {
                            text: "Download and Install";
                            width: (window_width / 2) - 40px;
                            clicked => {
                                if file-results.length != 0 && files-table.current-row != -1 {
                                    download-file(file-results[files-table.current-row], downloads-list.length);
                                }
                            }
                        }
                    }
                }
            }

            downloads := Tab {
                title: "Downloads";
                VerticalBox {
                    for dl in downloads-map: Text {
                        text: dl.value.name;
                    }
                    FileTable {
                        columns: [{ title: "Name" }, { title: "Size" }, { title: "Progress" }];
                        files: downloads-list;
                    }
                }
            }
        }
    }
}
